The most part of the code taken from here:
http://stackoverflow.com/a/14084688
